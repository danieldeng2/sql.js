<meta charset="utf8" />
<html>
<script src='../dist/sql-wasm-debug.js'></script>
<script defer>
  function valconcat(vals, tagName) {
    if (vals.length === 0) return '';
    var open = '<' + tagName + '>', close = '</' + tagName + '>';
    return open + vals.join(close + open) + close;
  }

  window.onload = async () => {
    const dbFileElm = document.getElementById('dbfile');
    const outputElm = document.getElementById('output');
    const outputTableHeadElem = document.getElementById('outputTableHead');
    const outputTableBodyElem = document.getElementById('outputTableBody');
    const executeButton = document.getElementById('execute');

    const SQL = await initSqlJs({
      locateFile: (filename, prefix) => {
        return `../dist/${filename}`;
      }
    });
    executeButton.onclick = () => {
      const f = dbFileElm.files[0];
      const r = new FileReader();
      r.onload = function () {
        const Uints = new Uint8Array(r.result);
        const db = new SQL.Database(Uints);
        // const stmt = db.prepare(`SELECT L_LINENUMBER + 1 FROM lineitem LIMIT 10;`);
        const stmt = db.prepare(`
        select l_returnflag,
    l_linestatus,
    sum(l_quantity) as sum_qty,
    sum(l_extendedprice) as sum_base_price,
    sum(l_extendedprice *(1 - l_discount)) as sum_disc_price,
    sum(l_extendedprice *(1 - l_discount) * (1 + l_tax)) as sum_charge,
    avg(l_quantity) as avg_qty,
    avg(l_extendedprice) as avg_price,
    avg(l_discount) as avg_disc,
    count(*) as count_order
from lineitem
where l_shipdate <= date('1998-12-01', '+90 day')
group by l_returnflag,
    l_linestatus
order by l_returnflag,
    l_linestatus;
    `);
        outputTableHeadElem.innerHTML = "";
        outputTableBodyElem.innerHTML = "";
        let tableBody = "";
        stmt.jit();
        while (stmt.step()) {
          const columnNames = stmt.getColumnNames();
          const row = stmt.get();
          outputTableHeadElem.innerHTML = valconcat(columnNames, 'th');
          tableBody += `<tr>${valconcat(row, 'td')}</tr>`;
        };
        outputTableBodyElem.innerHTML = tableBody;
      }
      r.readAsArrayBuffer(f);
    }
  };
</script>

<head>
  <title>JustInTime</title>
</head>

<body>
  <label class="button">Load an SQLite database file: <input type='file' id='dbfile'></label>
  <br>
  <button id="execute" class="button">Execute</button>
  <br>
  <table>
    <thead id="outputTableHead">
      <th>
        Outputs will appear here.
      </th>
    <tbody id="outputTableBody"></tbody>
    </thead>
  </table>
</body>

</html>